{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudWatch monitoring resources for personal site",
  "Parameters": {
    "env": {
      "Type": "String",
      "Description": "Environment name (dev, staging, prod)"
    },
    "functionpitchHandlerName": {
      "Type": "String",
      "Description": "Name of the pitch handler Lambda function"
    },
    "functionleadHandlerName": {
      "Type": "String",
      "Description": "Name of the lead handler Lambda function"
    },
    "functionhealthHandlerName": {
      "Type": "String",
      "Description": "Name of the health handler Lambda function"
    },
    "alertEmail": {
      "Type": "String",
      "Default": "alerts@marko.dev",
      "Description": "Email address for CloudWatch alarms"
    }
  },
  "Resources": {
    "PitchHandlerLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/lambda/${functionpitchHandlerName}"
        },
        "RetentionInDays": 30
      }
    },
    "LeadHandlerLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/lambda/${functionleadHandlerName}"
        },
        "RetentionInDays": 30
      }
    },
    "HealthHandlerLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/lambda/${functionhealthHandlerName}"
        },
        "RetentionInDays": 30
      }
    },
    "AlertTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {
          "Fn::Sub": "personal-site-alerts-${env}"
        },
        "DisplayName": "Personal Site Alerts"
      }
    },
    "AlertSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "Protocol": "email",
        "TopicArn": {
          "Ref": "AlertTopic"
        },
        "Endpoint": {
          "Ref": "alertEmail"
        }
      }
    },
    "HighErrorRateAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "personal-site-high-error-rate-${env}"
        },
        "AlarmDescription": "Alarm when error rate is too high",
        "MetricName": "ErrorCount",
        "Namespace": "PersonalSite",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "Stage",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "AlertTopic"
          }
        ]
      }
    },
    "HighLatencyAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "personal-site-high-latency-${env}"
        },
        "AlarmDescription": "Alarm when response latency is too high",
        "MetricName": "RequestLatency",
        "Namespace": "PersonalSite",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "Stage",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "AlertTopic"
          }
        ]
      }
    },
    "LambdaErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "personal-site-lambda-errors-${env}"
        },
        "AlarmDescription": "Alarm when Lambda functions have errors",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 1,
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "AlarmActions": [
          {
            "Ref": "AlertTopic"
          }
        ]
      }
    },
    "RateLimitAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "personal-site-rate-limit-hits-${env}"
        },
        "AlarmDescription": "Alarm when rate limiting is frequently triggered",
        "MetricName": "RateLimitHits",
        "Namespace": "PersonalSite",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "Stage",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "AlertTopic"
          }
        ]
      }
    }
  },
  "Outputs": {
    "AlertTopicArn": {
      "Description": "ARN of the SNS topic for alerts",
      "Value": {
        "Ref": "AlertTopic"
      }
    },
    "PitchLogGroupName": {
      "Description": "Name of the pitch handler log group",
      "Value": {
        "Ref": "PitchHandlerLogGroup"
      }
    },
    "LeadLogGroupName": {
      "Description": "Name of the lead handler log group",
      "Value": {
        "Ref": "LeadHandlerLogGroup"
      }
    },
    "HealthLogGroupName": {
      "Description": "Name of the health handler log group",
      "Value": {
        "Ref": "HealthHandlerLogGroup"
      }
    }
  }
}