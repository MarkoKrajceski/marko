version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Install dependencies
            - npm ci
            # Inject environment-specific configurations
            - node amplify/scripts/build-env-injection.js
            # Validate environment variables before build
            - npm run validate:env:frontend
        build:
          commands:
            # Build the Next.js application with environment validation
            - npm run build
        postBuild:
          commands:
            # Optional: Run additional validation after build
            - echo "Build completed successfully"
      artifacts:
        # Specify the build output directory
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          # Cache node_modules and Next.js cache for faster builds
          - node_modules/**/*
          - .next/cache/**/*
      # Environment variables for the build process
      # Most variables are AUTO-GENERATED by build-env-injection.js script
      # Only set these in Amplify Console if you need to override defaults
      environmentVariables:
        # Build-time variables (automatically set by Amplify)
        - AMPLIFY_APP_ID
        - AMPLIFY_BRANCH
        - AMPLIFY_COMMIT_ID
        # Optional overrides (leave empty to use auto-generated values)
        # - STAGE                    # Auto-generated from branch name
        # - NEXT_PUBLIC_API_URL      # Auto-generated from API Gateway
        # - NEXT_PUBLIC_SITE_URL     # Auto-generated from Amplify domain
  - backend:
      phases:
        preBuild:
          commands:
            # Inject backend environment configurations
            - node amplify/scripts/build-env-injection.js
            # Validate backend environment variables
            - echo "Validating backend environment variables..."
            - node scripts/validate-env.js --backend
        build:
          commands:
            # Build backend functions with environment injection
            - echo "Building backend functions with injected environment..."
        postBuild:
          commands:
            # Validate final backend configuration
            - echo "Validating final backend configuration..."
            - node scripts/validate-env.js --backend
            - echo "Backend build completed successfully"
      # Environment variables for Lambda functions
      # Most variables are AUTO-GENERATED by build-env-injection.js script
      environmentVariables:
        # Auto-generated variables (no need to set in Amplify Console)
        # - STAGE                    # Auto-generated from branch name
        # - TABLE_NAME               # Auto-generated as personalSiteData-{stage}
        # - AWS_REGION               # Auto-detected from Amplify environment
        # - CORS_ORIGIN              # Auto-generated from site URL
        # Optional overrides (only set if you need custom values)
        # - RATE_LIMIT_MAX           # Defaults: dev=10, prod=30
        # - RATE_LIMIT_WINDOW        # Default: 60 seconds

# Custom headers for security and performance
customHeaders:
  - pattern: '**/*'
    headers:
      # Security headers
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains'
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'Referrer-Policy'
        value: 'strict-origin-when-cross-origin'
      - key: 'Permissions-Policy'
        value: 'camera=(), microphone=(), geolocation=()'
      # Performance headers
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  - pattern: '*.html'
    headers:
      # HTML files should not be cached aggressively
      - key: 'Cache-Control'
        value: 'public, max-age=0, must-revalidate'
  - pattern: '/api/**'
    headers:
      # API responses should not be cached
      - key: 'Cache-Control'
        value: 'no-cache, no-store, must-revalidate'

# Redirects for clean URLs and HTTPS enforcement
redirects:
  - source: 'http://marko.dev/<*>'
    target: 'https://marko.dev/<*>'
    status: '301'
  - source: 'http://www.marko.dev/<*>'
    target: 'https://marko.dev/<*>'
    status: '301'
  - source: 'https://www.marko.dev/<*>'
    target: 'https://marko.dev/<*>'
    status: '301'

# Environment-specific configuration
# This section can be customized per branch/environment
test:
  phases:
    preTest:
      commands:
        # Run environment validation tests
        - npm run validate:env:all
    test:
      commands:
        # Run any additional tests
        - echo "Running tests..."
  artifacts:
    baseDirectory: /
    files:
      - '**/*'